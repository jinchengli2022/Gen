还需要继续解决的问题
1.之前没有考虑到20Hz的控制频率
2.仿真环境中这个机械臂到底是怎么运作的？？？
返回的归一值代表机械臂相对目前移动多少距离，返回的并不是速度
因此我考虑的角度应该是限距，而不是限速
3.为什么Debug可视化不能将问题可视化？？？


# 限距体系重构总结

## 核心认知修正

**"限速"→"限距"**：仿真环境中，action 归一化值表示的是"相邻帧间机械臂移动的距离比例"，而不是速度。因此所有约束都是"限距"——限制相邻帧间移动的最大距离。

### 旧逻辑（错误）
- `max_dpos` / `max_drot` 被同时当作"机器人归一化上限"和"速度限制"
- 概念混淆：`output_max` 是机器人控制器固有属性，不是用户可调的限距参数
- 可视化/预处理器中参数名混乱，物理值和归一化值不分

### 新逻辑（正确）

| 概念 | 变量名 | 含义 | 来源 |
|------|--------|------|------|
| 归一化上限 | `output_max_pos` / `output_max_rot` | 控制器将物理增量映射到 [-1, 1] 的除数 | `composite_controller_config['body_parts']['right']['output_max']` |
| 限距阈值（归一化空间） | `limit_dpos` / `limit_drot` | 用户设定的归一化空间距离上限，范围 [0, 1] | `config.limit_dpos` / `config.limit_drot`（JSON 配置） |
| 物理空间限距 | `physical_limit_dpos` / `physical_limit_drot` | 实际物理空间限距阈值（米 / 弧度） | `= limit × output_max` |

**公式**：`physical_limit = limit × output_max`

---

## 修改的文件

### 1. `Gen/configs/config.py`
- `max_dpos: float = 0.05` → `limit_dpos: float = 0.85`
- `max_drot: float = 0.15` → `limit_drot: float = 1.0`
- 注释更新：说明为归一化空间 [0, 1] 的限距阈值

### 2. `Gen/configs/examples/pouring_water_trajgen.json`（用户手动编辑）
- `"max_dpos": 0.05` → `"limit_dpos": 0.85`
- `"max_drot": 0.15` → `"limit_drot": 1.0`

### 3. `Gen/scripts/gen.py`

#### WaypointPolicy 类
- **构造函数参数**: `max_dpos=0.05, max_drot=0.15` → `limit_dpos=0.85, limit_drot=1.0`
- **属性**: `self.max_dpos/max_drot` → `self.limit_dpos/limit_drot`
- **get_action()**:
  - 局部变量 `max_dpos/max_drot` → `output_max_pos/output_max_rot`（从机器人控制器读取）
  - 归一化: `delta_position / output_max_pos` → `normalized_dpos`
  - 限距检查: `|normalized_dpos| > self.limit_dpos`（在归一化空间比较）

#### main() 函数
- 从环境读取 `output_max_pos` / `output_max_rot`
- 计算物理限距: `physical_limit_dpos = config.limit_dpos * output_max_pos`
- 传递物理限距给 `SourceDemoPreprocessor` 和 `TrajectoryGenerator`
- `WaypointPolicy` 创建时传入 `limit_dpos=config.limit_dpos, limit_drot=config.limit_drot`
- 日志记录: 输出 `limit_dpos`, `limit_drot`, `output_max`, `physical_limit` 等信息
- 所有中文注释/日志中"限速"→"限距"

### 4. `Gen/utils/trajectory_generator.py`
- `self.limit_dpos` / `self.limit_drot` → `self.physical_limit_dpos` / `self.physical_limit_drot`
- 注释: "限速" → "限距"
- 传递给 `visualize_trajectory()` 时: `physical_limit_dpos=self.physical_limit_dpos`

### 5. `Gen/utils/trajectory_visualizer.py`（完全重写）
- 函数 `_detect_overspeed_points()` → `_detect_overdist_points()`
- 参数 `limit_dpos/limit_drot` → `physical_limit_dpos/physical_limit_drot`
- 所有内部变量: `overspeed_*` → `overdist_*`
- 图表标签: `Overspeed` → `Over-distance`
- 中文日志: "超速" → "超距"
- **判断标准**: 使用物理空间阈值（米/弧度）比较物理空间增量 ✓

### 6. `Gen/utils/source_preprocessor.py`
- **构造函数参数**: `max_dpos/max_drot` → `physical_limit_dpos/physical_limit_drot`
- **属性**: `self.max_dpos/max_drot` → `self.physical_limit_dpos/physical_limit_drot`
- **所有文档/打印**: "限速" → "限距"，"超速" → "超距"

---

## 命名规范

整个代码库中 `max_dpos` / `max_drot` / "限速" / "超速" 已完全消除：

```
grep -rn "max_dpos\|max_drot" Gen/ --include="*.py"    → 0 匹配
grep -rn "限速\|超速" Gen/ --include="*.py"             → 0 匹配
```

三层命名：
- **配置层**: `limit_dpos` / `limit_drot`（归一化空间，[0, 1]）
- **物理层**: `physical_limit_dpos` / `physical_limit_drot`（米/弧度）
- **控制器固有值**: `output_max_pos` / `output_max_rot`（从机器人读取）

## 可视化判断标准确认

`trajectory_visualizer.py` 中的 `_detect_overdist_points()` 接收的是 `physical_limit_dpos`（物理空间值，单位：米），与物理空间位置增量 `pos_delta` 直接比较——这是正确的。调用链：
```
gen.py: physical_limit_dpos = config.limit_dpos * output_max_pos  (物理值)
    → traj_generator.physical_limit_dpos = physical_limit_dpos
        → visualize_trajectory(physical_limit_dpos=self.physical_limit_dpos)
            → _detect_overdist_points(physical_limit_dpos=...)  # 物理空间比物理空间 ✓
```
